@inject IAuthService AuthService
@inject IInterestService InterestService

<MudText Typo="Typo.h6">Change Created Interest Name</MudText>

<MudTable Items="@Interests" Hover="true" Breakpoint="Breakpoint.Sm">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Change Interest Name</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Sign">@context.Name</MudTd>
        <MudTd DataLabel="Change Interest Name">
            <MudIconButton @onclick="(() => DisplayForm(context))" Icon="@Icons.Filled.Edit" Color="Color.Dark" aria-label="delete"></MudIconButton>
        </MudTd>
    </RowTemplate>
</MudTable>

@if (ShowEditForm)
{
    <EditForm Model="interestToUpdate" OnSubmit="ChangeInterest">
        <DataAnnotationsValidator />
        <MudGrid>
            <MudItem xs="12" sm="7">
                <MudCard>
                    <MudCardContent>
                        <MudTextField Label="Interest" @bind-Value="interestToUpdate.Name" />
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Change</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    </EditForm>
}

<p>@Message</p>

@code {
    [Parameter]
    public EventCallback RefreshInterests { get; set; }
    private List<InterestModel> Interests { get; set; } = new();
    UserAuth user = new();
    private string? Message { get; set; }
    private bool ShowEditForm { get; set; }
    private int InterestId { get; set; }
    private bool UserIsAdmin { get; set; }
    private InterestUpdateDto interestToUpdate { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await AuthService.GetUser();
        UserIsAdmin = await AuthService.IsAdmin();
        await GetInterestsByRole();
    }

    public async Task ChangeInterest()
    {
        interestToUpdate.Id = InterestId;
        await InterestService.UpdateInterest(interestToUpdate);
        await InvokeRefreshInterests();
    }

    public void DisplayForm(InterestModel interest)
    {
        if (UserIsAdmin || interest.Threads.Count <= 0)
        {
            ShowEditForm = ShowEditForm == false ? true : false;
            InterestId = interest.Id;
            Message = "";
        }
        else if (interest.Threads.Count > 0)
        {
            ShowEditForm = false;
            Message = "Not allowed to edit interest";
        }
    }

    private async Task InvokeRefreshInterests()
    {
        await RefreshInterests.InvokeAsync();
        await GetInterestsByRole();
    }

    private async Task GetInterestsByRole()
    {
        if (await AuthService.IsAdmin())
        {
            await InterestService.GetInterests();
            Interests = InterestService.Interests;
        }
        else
        {
            Interests = await InterestService.GetUserCreatedInterests(user.Id);
        }
    }
}
